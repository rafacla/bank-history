{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block content %}
  <!-- Page header -->
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Page pre-title -->
          <div class="page-pretitle">Overview</div>
          <h2 class="page-title">{% trans "Transactions" %}</h2>
        </div>
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <div>
                <a href="#"
                   class="btn dropdown-toggle on-hover-button"
                   data-bs-toggle="dropdown"
                   data-bs-auto-close="outside"
                   role="button"
                   id="edit_button">
                  <!-- Download SVG icon from http://tabler-icons.io/i/edit -->
                  <svg xmlns="http://www.w3.org/2000/svg"
                       class="icon icon-tabler icon-tabler-edit"
                       width="24"
                       height="24"
                       viewBox="0 0 24 24"
                       stroke-width="2"
                       stroke="currentColor"
                       fill="none"
                       stroke-linecap="round"
                       stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                    <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                    <path d="M16 5l3 3" />
                  </svg>
                  {% trans "Edit Transaction(s)" %}
                </a>
                <div class="dropdown-menu" aria-labelledby="edit_button">
                  <span class="dropdown-header">{% trans "Edit multiple transactions" %}</span>
                  <a class="dropdown-item" href="#" id="categorizeTransactions">
                    <!-- Download SVG icon from http://tabler-icons.io/i/category -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-category" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4h6v6h-6z" /><path d="M14 4h6v6h-6z" /><path d="M4 14h6v6h-6z" /><path d="M17 17m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" /></svg>
                    {% trans "Set category" %}
                  </a>
                  <a class="dropdown-item" id="setInternalTransfer" href="#">
                    <!-- Download SVG icon from http://tabler-icons.io/i/transfer -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-transfer" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 10h-16l5.5 -6" /><path d="M4 14h16l-5.5 6" /></svg>
                    {% trans "Mark as internal transfer" %}
                  </a>
                  <a class="dropdown-item" id="deleteTransactions" href="#">
                    <!-- Download SVG icon from http://tabler-icons.io/i/trash -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                    {% trans "Delete" %}
                  </a>
                </div>
              </div>
              <a href="#"
                 class="btn btn-primary d-none d-sm-inline-block modal-button"
                 data-form-url="{% url "banking:transaction_create" %}"
                 data-bs-toggle="modal"
                 data-bs-target="#modals-here"
                 id="add_button">
                <!-- Download SVG icon from http://tabler-icons.io/i/plus -->
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="icon"
                     width="24"
                     height="24"
                     viewBox="0 0 24 24"
                     stroke-width="2"
                     stroke="currentColor"
                     fill="none"
                     stroke-linecap="round"
                     stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M12 5l0 14"></path>
                  <path d="M5 12l14 0"></path>
                </svg>
                {% trans "Create Transaction" %}
              </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Page body -->
  <div class="page-body">
    <div class="container-xl">
      <div class="row row-deck row-cards">
        <div class="col-12">
          <div class="card">
            <div class="card-head"></div>
            <div class="table-responsive">
              <table class="table card-table table-vcenter text-nowrap datatable table-hover table-condensed">
                <thead>
                  <tr>
                    <th>
                      <input id="select-all"
                             class="form-check-input m-0 align-middle"
                             type="checkbox"
                             aria-label="Select all transactions">
                    </th>
                    <th>
                      <svg xmlns="http://www.w3.org/2000/svg"
                           class="icon icon-tabler icon-tabler-info-circle"
                           width="24"
                           height="24"
                           viewBox="0 0 24 24"
                           stroke-width="2"
                           stroke="currentColor"
                           fill="none"
                           stroke-linecap="round"
                           stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" />
                        <path d="M12 9h.01" />
                        <path d="M11 12h1v4h1" />
                      </svg>
                    </th>
                    <th>{% trans "Account" %}</th>
                    <th>{% trans "Competency" %}</th>
                    <th>{% trans "Date" %}</th>
                    <th>{% trans "Description" %}</th>
                    <th>{% trans "Category" %}</th>
                    <th class="text-end">{% trans "Value" %}</th>
                    <th class="text-end">{% trans "Balance" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% if transaction_list.count == 0 %}
                    <tr>
                      <td colspan="9">{% trans "No transactions yet for the given filter" %} üòê</td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="8" class="text-end">
                        {% trans "Account balance for current filter before" %} {{ first_date|date:"d/m/Y" }}
                      </td>
                      <td class="text-end">{{ balance_first_date|floatformat:2 }}</td>
                    </tr>
                    {% for item in transaction_list %}
                      {% if item.merged_to == None %}
                        <tr>
                          <td>
                            <input class="form-check-input m-0 align-middle"
                                   type="checkbox"
                                   aria-label="Select transaction of {{ item.date }}"
                                   id="{{ item.id }}">
                          </td>
                          <td>
                            {% if item.getMergedTransactions.count > 0 %}
                              <svg data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="{% trans "There's one or more transactions merged to this one. Click at Transaction to show more details" %}" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M9 15l6 -6" />
                                <path d="M11 6l.463 -.536a5 5 0 0 1 7.071 7.072l-.534 .464" />
                                <path d="M13 18l-.397 .534a5.068 5.068 0 0 1 -7.127 0a4.972 4.972 0 0 1 0 -7.071l.524 -.463" />
                              </svg>
                            {% endif %}
                          </td>
                          <td>{{ item.account.name }}</td>
                          <td>
                            {% if item.competency_date != None %}
                              {{ item.competency_date|date:"b-y" }}
                            {% else %}
                              {{ item.date|date:"b-y" }}
                            {% endif %}
                          </td>
                          <td>{{ item.date|date:"d/m/Y" }}</td>
                          <td>
                            {{ item.description }} <a href="#"
    data-form-url="{% url 'banking:transaction_update' item.id %}"
    class="modal-button on-hover-link"
    data-bs-toggle="modal"
    data-bs-target="#modals-here">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="icon icon-tabler icon-tabler-edit"
                                 width="24"
                                 height="24"
                                 viewBox="0 0 24 24"
                                 stroke-width="2"
                                 stroke="currentColor"
                                 fill="none"
                                 stroke-linecap="round"
                                 stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                              <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                              <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                              <path d="M16 5l3 3" />
                            </svg>
                          </a>
                        </td>
                        <td>
                          {% if item.is_transfer %}
                            <span data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="{% trans "This is a Transfer! It doesn't need a Category, because this is only internal money moving from your own account and not actual spending!" %}">
                              <svg xmlns="http://www.w3.org/2000/svg"
                                   class="icon icon-tabler icon-tabler-transfer"
                                   width="24"
                                   height="24"
                                   viewBox="0 0 24 24"
                                   stroke-width="2"
                                   stroke="currentColor"
                                   fill="none"
                                   stroke-linecap="round"
                                   stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M20 10h-16l5.5 -6" />
                                <path d="M4 14h16l-5.5 6" />
                              </svg>
                              Internal Transfer
                            </span>
                          {% elif item.category != None %}
                            <span data-bs-toggle="popover"
                                  data-bs-trigger="hover focus"
                                  data-bs-content="{% trans "This is a categorized transaction, it means you are spending or receiving money!" %}">
                              <svg xmlns="http://www.w3.org/2000/svg"
                                   class="icon icon-tabler icon-tabler-category-2"
                                   width="24"
                                   height="24"
                                   viewBox="0 0 24 24"
                                   stroke-width="2"
                                   stroke="currentColor"
                                   fill="none"
                                   stroke-linecap="round"
                                   stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M14 4h6v6h-6z" />
                                <path d="M4 14h6v6h-6z" />
                                <path d="M17 17m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                                <path d="M7 7m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                              </svg>
                              {{ item.category.name }}
                            </span>
                          {% else %}
                            <span class="badge m-0 h6 text-bg-warning" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="{% trans "You did not classified this transaction! It's always recommended that you classify every transaction to get control of your finances!" %}">
                              <svg xmlns="http://www.w3.org/2000/svg"
                                   class="icon icon-tabler icon-tabler-alert-triangle"
                                   width="24"
                                   height="24"
                                   viewBox="0 0 24 24"
                                   stroke-width="2"
                                   stroke="currentColor"
                                   fill="none"
                                   stroke-linecap="round"
                                   stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M12 9v4" />
                                <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
                                <path d="M12 16h.01" />
                              </svg>
                              {% trans "Not classified" %}
                            </span>
                          {% endif %}
                        </td>
                        <td class="text-end">{{ item.value|floatformat:2 }}</td>
                        <td class="text-end">{{ item.balance|floatformat:2 }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                  <tr>
                    <td colspan="8" class="text-end">{% trans "Account balance for current filter on" %} {{ last_date|date:"d/m/Y" }}</td>
                    <td class="text-end">{{ balance_last_date|floatformat:2 }}</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
{% block extrascripts %}
<script>
  document.addEventListener('DOMContentLoaded', (e) => {
    var modalButtons = document.getElementsByClassName("modal-button");
    for (var index=0; index < modalButtons.length; index++) {
      modalForm(modalButtons[index], {
        formURL: modalButtons[index]["dataset"]["formUrl"],
        modalID: "#modals-here",
        isDeleteForm: (modalButtons[index]["dataset"]["formDelete"] == true),
      });
    }
  });
  // Listen for click on toggle checkbox
  $('#select-all').click(function(event) {   
    if(this.checked) {
        // Iterate each checkbox
        $(':checkbox').each(function() {
            this.checked = true;                        
        });
    } else {
        $(':checkbox').each(function() {
            this.checked = false;                       
        });
    }
  }); 
  $(':checkbox').change(function(){
    var checked = false;
    var checked_ids = ""
    $(':checkbox').each(function() {
      if (checked != true && this.checked) {
        checked = true;
      }
      if (this.checked) {
        if (this.id != "select-all") {
          checked_ids = checked_ids + this.id + ",";
        }
      }
    });
    if (checked) {
       $("#edit_button").show()
    }else{
      $("#edit_button").hide()
    }
    let url_string = "{% url 'banking:transaction_delete' 0 %}"
    url_string = url_string.slice(0, -2) + checked_ids.slice(0, -1) + "/"
    
    modalForm(document.getElementById('deleteTransactions'), {
      formURL: url_string,
      modalID: "#modals-here",
      isDeleteForm: true,
    });

    url_string = "{% url 'banking:transaction_internal_transfer' 0 %}"
    url_string = url_string.slice(0, -2) + checked_ids.slice(0, -1) + "/"

    modalForm(document.getElementById('setInternalTransfer'), {
      formURL: url_string,
      modalID: "#modals-here",
      isDeleteForm: true,
    });

    url_string = "{% url 'banking:transaction_categorize' 0 %}"
    url_string = url_string.slice(0, -2) + checked_ids.slice(0, -1) + "/"

    modalForm(document.getElementById('categorizeTransactions'), {
      formURL: url_string,
      modalID: "#modals-here",
      isDeleteForm: true,
    });
});
$("#edit_button").hide()
</script>
{% endblock extrascripts %}